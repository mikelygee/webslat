{% extends "base_site.html" %}
{% load i18n static %}
{% block extrastyle %}{{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'slat/style.css' %}?{ now "U" %}" />
    <script src="{% static "js/jquery-3.2.1.min.js" %}"></script>
    <script src="{% static "js/slat-utils.js" %}"></script>
    <script type="text/javascript">
      var delete_image = function(index) {
          var e = document.getElementById("id_form-" + (index - 1) + "-image")
          e.value = null
      
          e = document.getElementById("id_form-" + (index - 1) + "-image-preview")
          e.hidden = true
          e = document.getElementById("id_form-" + (index - 1) + "-image-delete-button")
          e.hidden = true
      }
      
      var replace_image = function(self, index) {
          var e = document.getElementById("id_form-" + (index - 1) + "-image")
          //console.log("replace " + e.value + " with " + self.files[0].name)
          e.value = self.files[0].name

          //console.log(self.files[0])
          var img = document.getElementById("id_form-" + (index - 1) + "-image-preview")
          img.hidden = false
          img.src = window.URL.createObjectURL(self.files[0]);
          img.onload = function (e)
          {
             window.URL.revokeObjectURL(this.src);
          }

          e = document.getElementById("id_form-" + (index - 1) + "-image-delete-button")
          e.hidden = false
      }

    var prefixes = ["cost", "fragility"]

    function add_damage_state() {
        for (p in prefixes) {
            prefix = prefixes[p]

            var total_forms_element = document.getElementById(
                "id_" + prefix + "_form-TOTAL_FORMS")
            n_forms = parseInt(total_forms_element.value)
            total_forms_element.value = n_forms + 1

            var table = document.getElementById("id_" + prefix + "_table")
            var tbody = table.children[0]
            var rows = tbody.rows
            var n_rows = rows.length

            var new_data_row = rows[n_rows - 2].cloneNode(true)
            new_data_row.cells[0].textContent = "DS" + (n_forms + 1)
            var tags = ['input', 'textarea']
            for (t in tags) {
                tag = tags[t]
                inputs = new_data_row.getElementsByTagName(tag)
                for (i=0; i < inputs.length; i++) {
                    input = inputs[i]
                    input.name = input.name.replace(/-[0-9]+-/, '-' + n_forms + '-')
                    input.id = input.id.replace(/-[0-9]+-/, '-' + n_forms + '-')
                    if (RegExp('-state$').test(input.id)) {
                        input.value = n_forms + 1
                    }
                }
            }
            var new_error_row = rows[n_rows - 1].cloneNode(true)

            tbody.rows[n_rows - 2].hidden = false
            tbody.appendChild(new_data_row)
            tbody.appendChild(new_error_row)
        }
    }

    var strip_extras = function() {
        for (p in prefixes) {
            prefix = prefixes[p]
            var total_forms_element = document.getElementById(
                "id_" + prefix + "_form-TOTAL_FORMS")

            n_forms = parseInt(total_forms_element.value)
            total_forms_element.value = n_forms - 1
        }
        return(true);
    }
    </script>

    {{ form.media }}
{% endblock %}

{% block bodyclass %}{{ block.super }} slat {% endblock %}
{% block title %}WebSLAT: Component {{ component.ident }}{% endblock %}
{% block content_title %}WebSLAT: Component {{ component.ident }}{% endblock %}
{% block content %}
    {% comment %}
        {% if not component_form.is_valid or not cost_form.is_valid or not fragility_form.is_valid %}
            {{ component_form.is_valid }}
        {{ cost_form.is_valid }}
        {{ fragility_form.is_valid }}
            <p><b>Errors:</b></p>
            {{ component_form.errors }}
            {% for e in cost_form.errors %}
                {% if e %}
                    <p><i>{{ e }}</i></p>
                {% endif %}
            {% endfor %}
            {% for e in fragility_form.errors %}
                {% if e %}
                    <p><i>{{ e }}</i></p>
                {% endif %}
            {% endfor %}
            <hr/>
        {% endif %}
    {% endcomment %}
{% if component_form.instance.key %}
    <form enctype="multipart/form-data" action="{% url 'slat:edit_component' component_form.instance.key %}"
{% else %}
    <form enctype="multipart/form-data" action="{% url 'slat:edit_component' %}" 
      {% endif %}
          onsubmit="return strip_extras()" method="post">
    {% csrf_token %}
   <input type="button" onclick="strip_extras()" name="test" value="test" />
{{ component_form.key }}
<table id="id_component_table">
  <tr><th>{{ component_form.ident.label }}</th><td>{{ component_form.ident }}</td>
    {% if component_form.errors.ident %}
    <td class="error">{{ component_form.errors.ident }}</td>
    {% endif %}
  </tr>
  <tr><th>{{ component_form.name.label }}</th><td>{{ component_form.name }}</td>
    {% if component_form.errors.name %}
    <td class="error">{{ component_form.errors.name }}</td>
    {% endif %}
  </tr>
  <tr><th>{{ component_form.system.label }}</th><td>{{ component_form.system }}</td>
    {% if component_form.errors.system %}
    <td class="error">{{ component_form.errors.system }}</td>
    {% endif %}
  </tr>
  <tr><th>{{ component_form.units.label }}</th><td>{{ component_form.units }}</td>
    {% if component_form.errors.units %}
    <td class="error">{{ component_form.errors.units }}</td>
    {% endif %}
  </tr>
  <tr><th>{{ component_form.demand.label }}</th><td>{{ component_form.demand }}</td>
    {% if component_form.errors.demand %}
    <td class="error">{{ component_form.errors.demand }}</td>
    {% endif %}
  </tr>
  <tr><th>{{ component_form.structural.label }}</th><td>{{ component_form.structural }}</td>
    {% if component_form.errors.structural %}
    <td class="error">{{ component_form.errors.structural }}</td>
    {% endif %}
  </tr>
</table>
<hr/>
<input id="id-ds-add" type="button" style="border-width:thin; border-color:black" value="Add a damage state" title="Click to add a damage state." onclick="add_damage_state()"/>
<hr/>
<div id="id_costs">
<h3 title="Help text">Cost Data</h3>
{{ cost_form.management_form }}
{% if cost_form.non_form_errors %}
    <ul>
        {% for e in cost_form.non_form_errors %}
            <li class="error">{{ e }}</li>
        {% endfor %}
    </ul>
{% endif %}
<table border="1" id="id_cost_table">
  <tr><th style="border-bottom-style:hidden"></th>
    <th colspan="2" align="center" style="border-bottom-style:hidden; border-left-width:medium"">Lower</th>
    <th colspan="2" align="center" style="border-bottom-style:hidden; border-left-width:medium"">Upper</th>
    <th style="border-bottom-style:hidden; border-left-width:medium""></th></tr>
  <tr><th>State</th><th align="center" style="border-right-style:hidden; border-left-width:medium">Quantity</th>
    <th align="center">Per-Unit Cost</th>
    <th align="center" style="border-right-style:hidden; border-left-width:medium">Quantity</th>
    <th align="center">Per-Unit Cost</th>
    <th align="center" style="border-left-width:medium">Dispersion</th>
  </tr>
{% for cf in cost_form %}
  <tr style="background-color:{% cycle 'lightgray' 'white' as stripe %}"
      {% if forloop.last %}
         hidden
      {% endif %}
      >
      {{ cf.rowid }}{{ cf.state }}{{ cf.component }}
    <td>
      DS{{ cf.state.value }}
    </td>
    <td style="border-right-style:hidden; border-left-width:medium">{{ cf.lower_limit }}</td><td>{{ cf.max_cost }}</td>
    <td style="border-right-style:hidden; border-left-width:medium">{{ cf.upper_limit }}</td><td>{{ cf.min_cost }}</td>
    <td style="border-left-width:medium">{{ cf.dispersion }}</td>
    </tr>
  {% with forloop.counter|cut:" " as index %}
      {% with cost_form.errors|slice:index|last as errors %}
          <tr style="background-color:{{ stripe }}"       
              {% if forloop.last or not errors%}
                  hidden
              {% endif %}
          >
          <td></td> 
          {% if errors.lower_limit %}
              <td class="error">{{ errors.lower_limit }}</td>
          {% else %}
              <td></td>
          {% endif %}
          {% if errors.max_cost %}
    <td class="error">{{ errors.max_cost }}</td>
    {% else %}
    <td></td>
    {% endif %}
    {% if errors.upper_limit %}
    <td class="error">{{ errors.upper_limit }}</td>
    {% else %}
    <td></td>
    {% endif %}
    {% if errors.min_cost %}
    <td class="error">{{ errors.min_cost }}</td>
    {% else %}
    <td></td>
    {% endif %}
    {% if errors.dispersion %}
    <td class="error">{{ errors.dispersion }}</td>
    {% else %}
    <td></td>
    {% endif %}
    {% endwith %}
    {% endwith %}
    </td>
  </tr>
{% endfor %}
</table>
</div>
<hr/>
<div id="id_fragility">
<h3>Fragility Data</h3>
{{ fragility_form.management_form }}
{% if fragility_form.non_form_errors %}
    <ul>
        {% for e in fragility_form.non_form_errors %}
            <li class="error">{{ e }}</li>
        {% endfor %}
    </ul>
{% endif %}
<table id="id_fragility_table">
  <tr><th>State</th><th>Description</th><th>Repairs</th><th>Median EDP</th><th>Dispersion</th><th>Image</th></tr>
  {% for i in fragility_form %}
     <tr style="background-color:{% cycle 'lightgray' 'white' as stripe %}"
         {% if forloop.last %}
             hidden
         {% endif %}
      > 
       {{ i.state }}{{ i.rowid }}{{ i.component }}

       <td>DS{{ i.state.value }}</td>
       <td>{{ i.description }}</td>
       <td>{{ i.repairs }}</td>
       <td>{{ i.median }}</td>
       <td>{{ i.beta }}</td>
       <td>
         <table><tr><td>
         {{ i.image }}
         {% with forloop.counter|cut:" " as index %}
             <img id="id_form-{{ index|add:"-1" }}-image-preview" src="{% static "slat/images/" %}{{ i.instance.component.ident }}/{{ i.image.value }}"
                  {% if not i.image.value %}
                  hidden
                  {% endif %}
                  />
             </td>
             <td>
             <input id="id_form-{{ index|add:"-1" }}-image-delete-button"
                    type="button" style="border-width:thin; border-color:black" 
                    value="Delete Image" title="Click to delete this image." 
                    onclick="delete_image({{ index }})"
                    {% if not i.image.value %}
                        hidden="false"
                    {% endif %}
                    />
           </div>
         <input type="file" name="image-{{ index }}" id="id_path-{{ index }}" onchange="replace_image(this, {{ index }})"/>
         </td></tr></table>
         {% endwith %}
       </td></tr>
    {% with forloop.counter|cut:" " as index %}
        {% with fragility_form.errors|slice:index|last as errors %}
                <tr style="background-color:{{ stripe }}"
                    {% if forloop.last or not errors %}
                        hidden
                    {% endif %}
                >
                    <td></td> 
                      {% if errors.description %}
                          <td class="error">{{ errors.description }}</td>
                      {% else %}
                          <td></td>
                      {% endif %}
                      {% if errors.repairs %}
                          <td class="error">{{ errors.repairs }}</td>
                      {% else %}
                          <td></td>
                      {% endif %}
                      {% if errors.median %}
                          <td class="error">{{ errors.median }}</td>
                      {% else %}
                          <td></td>
                      {% endif %}
                      {% if errors.beta %}
                          <td class="error">{{ errors.beta }}</td>
                      {% else %}
                          <td></td>
                      {% endif %}
                          <td></td>
                  </tr>
        {% endwith %}
    {% endwith %}
  {% endfor %}
</table>
</div>
<br/>
<hr/>
{% if component_form.instance.key %}
    <input type="submit" value="Submit Changes" class="normal"/>
{% else %}
    <input type="submit" value="Create Component" class="normal"/>
{% endif %}
</form>
    {% if component_form.instance.key %}
        <form action="{% url 'slat:edit_component' component_form.instance.key %}"
    {% else %}
        <form enctype="multipart/form-data" action="{% url 'slat:edit_component' %}" 
    {% endif %}
              onsubmit="return strip_extras()"
              method="post">
    {% csrf_token %}

    <input type="submit" name="cancel" value="Cancel" />
    <input type="submit" name="back" value="Back to Component List" />
</form>
{% endblock %}
